<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Cetak Pesanan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* ===== THERMAL 58mm ===== */
    body {
      font-family: monospace;
      width: 58mm;
      margin: 0 auto;
      padding: 8px;
      font-size: 12px;
    }

    .center {
      text-align: center;
    }

    .right {
      text-align: right;
    }

    hr {
      border: none;
      border-top: 1px dashed #000;
      margin: 6px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      vertical-align: top;
      padding: 2px 0;
    }

    .bold {
      font-weight: bold;
    }

    .total {
      font-size: 14px;
      font-weight: bold;
    }

    @media print {
      button {
        display: none;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER TOKO -->
<div class="center bold" id="namaTokoHeader">
  -
</div>
<div class="center" id="alamatTokoHeader">
</div>
<div class="center">
  Struk Pesanan
</div>

  <hr>

  <!-- INFO PESANAN -->
<div>No: <span id="noPesanan">-</span></div>
<div>Tgl: <span id="tanggal">-</span></div>
<div>Pelanggan: <span id="namaPelanggan">-</span></div>
<div>Sales: <span id="sales">-</span></div>

  <hr>

  <!-- ITEM -->
  <table id="listItem">
    <tr>
      <td colspan="2" class="center">Belum ada item</td>
    </tr>
  </table>

  <hr>

  <!-- TOTAL -->
  <table>
    <tr>
      <td class="bold">TOTAL</td>
      <td class="right bold">
        Rp <span id="total">0</span>
      </td>
    </tr>
  </table>

  <hr>

  <div class="center">
    Terima kasih üôè
  </div>

  <div class="center" style="margin-top:10px">
    <button onclick="window.print()">üñ® Cetak</button>
  </div>

  <!-- SCRIPT -->
  <script>
const selectedItems =
  JSON.parse(localStorage.getItem("print_items") || "[]");

if (!selectedItems.length) {
  alert("Tidak ada item yang dipilih untuk dicetak");
}

  const API_URL = "https://script.google.com/macros/s/AKfycbzc7fFnO1J8wiitO1TGC_ubC5qy3p-ryJOJgtE_Vf-uxlKQ2Zr6S52C_oijqY6kJJMV/exec";

loadSettingToko();

  // Ambil parameter no dari URL
  const params = new URLSearchParams(window.location.search);
  const noPesanan = params.get("no");

  if (noPesanan) {
    document.getElementById("noPesanan").innerText = noPesanan;
    loadDetailPesanan(noPesanan);
  }

async function loadSettingToko() {
  try {
    const res = await fetch(API_URL + "?action=getSettingToko");
    const data = await res.json();

    if (!data) return;

    // Sesuaikan key setting dengan Apps Script kamu
    document.getElementById("namaTokoHeader").innerText =
      data.nama_toko || "TOKO";

    document.getElementById("alamatTokoHeader").innerText =
      data.alamat || "";

  } catch (err) {
    console.error("Gagal memuat setting toko", err);
  }
}

  async function loadDetailPesanan(no) {
    try {
      const res = await fetch(
        API_URL + "?action=getPesananDetail&no=" + encodeURIComponent(no)
      );
      const data = await res.json();

      if (!data || !data.items || !data.items.length) {
        alert("Data pesanan tidak ditemukan");
        return;
      }

      // Tanggal
      document.getElementById("tanggal").innerText =
        new Date(data.tanggal).toLocaleString();
// Nama toko & sales
document.getElementById("namaPelanggan").innerText = data.nama_toko || "-";
document.getElementById("sales").innerText = data.sales || "-";

      // Item
      const table = document.getElementById("listItem");
      table.innerHTML = "";

      let total = 0;

      selectedItems.forEach(item => {
        const tr1 = document.createElement("tr");
        tr1.innerHTML = `
          <td colspan="2">${item.produk}</td>
        `;

        const tr2 = document.createElement("tr");
        tr2.innerHTML = `
          <td>${item.qty} x ${Number(item.harga).toLocaleString()}</td>
          <td class="right">
            ${Number(item.subtotal).toLocaleString()}
          </td>
        `;

        table.appendChild(tr1);
        table.appendChild(tr2);

        total += Number(item.subtotal);
      });

      // Total
document.getElementById("total").innerText =
  total.toLocaleString();

// bersihkan data cetak
localStorage.removeItem("print_items");

    } catch (err) {
      console.error(err);
      alert("Gagal memuat data cetak");
    }
  }
</script>

</body>
</html>